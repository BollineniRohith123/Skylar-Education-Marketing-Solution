import { GoogleGenAI } from "@google/genai";

const apiKey = process.env.API_KEY || '';
const ai = new GoogleGenAI({ apiKey });

/**
 * PRODUCTION-GRADE STYLE PROMPT
 * Derived from "Identity_Safety" and "Camera_Details" best practices.
 * This forces the model to behave like a physical camera engine and treat the face as sacred data.
 */
const GLOBAL_REALISM_PROMPT = `
  CRITICAL INSTRUCTION - IDENTITY & MICRO-TEXTURE PRESERVATION:
  - ABSOLUTE FIDELITY: You MUST retain the EXACT facial features, bone structure, and unique identity markers of the input subject. Do NOT generate a generic AI face.
  - TEXTURE IMPERATIVE: Do NOT perform any skin smoothing, airbrushing, or "beautification". You must preserve visible pores, fine lines, freckles, and natural skin irregularities. The output must look like a raw, high-bitrate photograph, not a digital render.
  - EXPRESSION: Capture subtle micro-expressions and the specific gaze of the user. Do not neutralize or genericize the emotion.
  
  PHOTOGRAPHIC PHYSICS:
  - LIGHTING INTERACTION: Relight the face to match the target environment physically. Shadows must fall across the face according to the facial topography defined in the input image.
  - SUBSURFACE SCATTERING: Simulate realistic skin translucency.
  - CAMERA SPECS: Simulate a Sony A7R IV with an 85mm G Master lens. f/1.8 aperture for depth. Focus must be razor-sharp on the eyes with a natural optical falloff.
  
  COMPOSITION & FRAMING:
  - GENERATE A WAIST-UP PORTRAIT.
  - CENTER the subject in the frame.
  - Do NOT cut off the top of the head or the chin.
  - Ensure the head connects naturally to the new body (neck width, skin tone matching).
`;

/**
 * Uses Gemini 2.5 Flash Image to edit the user's photo.
 */
export const transformUserImage = async (
  base64Image: string,
  promptInstruction: string
): Promise<string> => {
  if (!apiKey) {
    throw new Error("API Key is missing. Please set process.env.API_KEY.");
  }

  try {
    // Remove data URL prefix
    const cleanBase64 = base64Image.replace(/^data:image\/(png|jpeg|jpg);base64,/, "");

    const model = 'gemini-2.5-flash-image'; 

    // Structure the prompt using the "Layered JSON-Logic" approach from the examples
    const fullPrompt = `
      OBJECTIVE: Create a photorealistic professional portrait of the user provided in the image.

      ${GLOBAL_REALISM_PROMPT}

      SCENE & ATTIRE SPECIFICATIONS:
      ${promptInstruction}
    `;

    const response = await ai.models.generateContent({
      model: model,
      contents: {
        parts: [
          {
            inlineData: {
              mimeType: 'image/jpeg',
              data: cleanBase64
            }
          },
          {
            text: fullPrompt
          }
        ]
      }
    });

    const candidates = response.candidates;
    if (candidates && candidates.length > 0) {
        const parts = candidates[0].content.parts;
        for (const part of parts) {
            if (part.inlineData && part.inlineData.data) {
                return `data:image/jpeg;base64,${part.inlineData.data}`;
            }
        }
    }

    throw new Error("No image generated by the model.");

  } catch (error) {
    console.error("Gemini Generation Error:", error);
    throw error;
  }
};