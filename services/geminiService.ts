import { GoogleGenAI } from "@google/genai";

const apiKey = process.env.API_KEY || '';
const ai = new GoogleGenAI({ apiKey });

/**
 * =============================================================================
 * SIMPLIFIED GLOBAL PROMPT
 * Based on analysis: Simple prompts produce natural face integration.
 * Complex face preservation instructions cause "patchy" face effect.
 * =============================================================================
 */
const GLOBAL_REALISM_PROMPT = `
PHOTO GUIDELINES:

STYLE:
‚Ä¢ Create a photorealistic image - like a real photograph taken with a camera.
‚Ä¢ Professional movie poster or magazine quality.
‚Ä¢ High resolution, sharp details, natural lighting.
‚Ä¢ NOT cartoon, NOT anime, NOT illustrated.

FACE:
‚Ä¢ Keep the person's face natural and clearly visible.
‚Ä¢ Same person from input photo, just in different clothes/setting.
‚Ä¢ Natural skin texture - not plastic or over-smoothed.

COMPOSITION:
‚Ä¢ Professional portrait framing.
‚Ä¢ Well-lit face.
‚Ä¢ Appropriate background for the scene.
`;

/**
 * Production Configuration
 * Temperature: 0.4 for consistency while maintaining creativity
 * (Research shows 0.3-0.5 optimal for consistent image generation)
 */
const GENERATION_CONFIG = {
  temperature: 0.4,      // Lower = more consistent results
  topP: 0.95,           // Keep high for quality
  topK: 40,             // Reasonable token selection
};

/**
 * Uses Gemini 2.5 Flash Image to transform the user's photo.
 * Production-optimized for consistent, print-ready results.
 */
export const transformUserImage = async (
  base64Image: string,
  promptInstruction: string
): Promise<string> => {
  console.log('üöÄ [GEMINI-PROD] Starting image transformation...');
  console.log('‚öôÔ∏è [GEMINI-PROD] Config:', JSON.stringify(GENERATION_CONFIG));

  if (!apiKey) {
    console.error('‚ùå [GEMINI-PROD] API Key is missing!');
    throw new Error("API Key is missing. Please set process.env.API_KEY.");
  }

  const startTime = Date.now();

  try {
    // Remove data URL prefix
    const cleanBase64 = base64Image.replace(/^data:image\/(png|jpeg|jpg);base64,/, "");
    console.log('üì∑ [GEMINI-PROD] Image size:', Math.round(cleanBase64.length / 1024), 'KB');

    const model = 'gemini-2.5-flash-image';

    // Structured prompt with clear sections
    const fullPrompt = `
${GLOBAL_REALISM_PROMPT}

=== COSTUME & SCENE INSTRUCTIONS ===
${promptInstruction}

=== OUTPUT REQUIREMENTS ===
‚Ä¢ Create a photorealistic, print-quality portrait.
‚Ä¢ The person's face MUST match the input photo exactly.
‚Ä¢ Style: Professional costume photography / movie poster quality.
‚Ä¢ Resolution: High quality suitable for 4x6 or larger prints.
`;

    console.log('üìù [GEMINI-PROD] Sending request with optimized settings...');

    const response = await ai.models.generateContent({
      model: model,
      contents: {
        parts: [
          {
            inlineData: {
              mimeType: 'image/jpeg',
              data: cleanBase64
            }
          },
          {
            text: fullPrompt
          }
        ]
      },
      config: {
        temperature: GENERATION_CONFIG.temperature,
        topP: GENERATION_CONFIG.topP,
        topK: GENERATION_CONFIG.topK,
      }
    });

    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    console.log(`‚úÖ [GEMINI-PROD] Response received in ${elapsed}s`);

    const candidates = response.candidates;

    if (candidates && candidates.length > 0) {
      const candidate = candidates[0];

      // Check for safety finish reason
      if (candidate.finishReason === 'SAFETY' || candidate.finishReason === 'BLOCKLIST') {
        console.warn(`‚ö†Ô∏è [GEMINI-PROD] Blocked by safety filter: ${candidate.finishReason}`);
        throw new Error("Generation blocked by safety settings. Please try a different photo.");
      }

      if (!candidate.content || !candidate.content.parts) {
        console.error('‚ùå [GEMINI-PROD] Candidate exists but has no content parts');
        throw new Error("No image data received from AI.");
      }

      const parts = candidate.content.parts;

      for (const part of parts) {
        if (part.inlineData && part.inlineData.data) {
          const resultSize = Math.round(part.inlineData.data.length / 1024);
          console.log(`üéâ [GEMINI-PROD] SUCCESS! Generated ${resultSize}KB image in ${elapsed}s`);
          return `data:image/jpeg;base64,${part.inlineData.data}`;
        }
        if (part.text) {
          console.log('üìù [GEMINI-PROD] Model text response:', part.text.substring(0, 200));
        }
      }
    }

    console.error('‚ùå [GEMINI-PROD] No image in response');
    throw new Error("No image generated by the model.");

  } catch (error: any) {
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    console.error(`‚ùå [GEMINI-PROD] Error after ${elapsed}s:`, error?.message);

    // Detailed error handling
    if (error?.message?.includes('429') || error?.message?.includes('quota')) {
      throw new Error("Rate limit exceeded. Please wait a moment and try again.");
    }
    if (error?.message?.includes('403')) {
      throw new Error("API permission denied. Please check your API key.");
    }
    if (error?.message?.includes('400')) {
      throw new Error("Invalid request. Please try a different photo.");
    }
    if (error?.message?.includes('Candidate was blocked due to safety')) {
      throw new Error("The image generation was blocked by safety filters. Please try a different pose or photo.");
    }

    throw error;
  }
};